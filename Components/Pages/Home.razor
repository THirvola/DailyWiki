@using System.Text.Json
@using DailyWiki.Scripts
@page "/"
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<h1>Daily Wikipedia page guessing game</h1>

@if (category.Equals("None"))
{
    @foreach (string cat in categories)
    {
        <button @onclick="(async () => { await PickCategory(cat);})">@cat</button>
    }
}
else if (!correctGuess)
{
    <h2>Category: @category</h2>
    <h2>Tries: @attempts</h2>
    <h3>hint 1: </h3> <p>@hint1</p>
    
    //After 2 failed attempts, the 2nd hit is shown
    if (attempts > 1)
    {
        <h3>hint 2:</h3> @hint2
    }

    @foreach (string option in options)
    {
        <button @onclick="(() => {PickAnswer(option);})">@option</button>
    }
}
else
{
    <h2>Category: @category</h2>
    <h2>Title: @title</h2>
    <h2>Tries: @attempts</h2>
}


@code{
    int attempts = 0;
    string title = "None";
    string pageId = "0";
    string hint1 = "None";
    string category = "None";
    List<string> categories = new List<string>() { "Physics", "Countries in Europe", "States of the United States", "Chemical elements", "Fish common names", "Chinese inventions" };
    List<string> options = new List<string>();
    bool correctGuess = false;
    List<MarkupString> paragraphs = new List<MarkupString>();
    MarkupString hint2 = (MarkupString)"None";

    /// <summary>
    /// Ran automatically on initialization. Used for initializing the page
    /// </summary>
    private async Task InitializeGame()
    {
        if (title.Equals("None"))
        {
            options = await WikipediaAPI.FetchPagesInCategory(category);
            title = options[new System.Random(GameEngine.GetRandomSeed()).Next(0, options.Count)];
        }

        try
        {
            var client = new HttpClient();
            //GET
            HttpResponseMessage resp = await client.GetAsync("https://en.wikipedia.org/w/api.php?action=parse&format=json&page=" + title + "&formatversion=2");
            string respString = await resp.Content.ReadAsStringAsync();

            //Parsing response
            Stream responseStream = resp.Content.ReadAsStream();
            JsonElement jsonRoot = JsonDocument.Parse(responseStream).RootElement;
            JsonElement parseResult = jsonRoot.GetProperty("parse");
            hint1 = GameEngine.CensorHint(title, parseResult.GetProperty("properties").GetProperty("wikibase-shortdesc").GetString()!);
            string description = WikipediaAPI.ParseWikipediaMarkup(parseResult.GetProperty("text").GetString()!, true, false);
            string[] splitDesc = description.Split("</p>", StringSplitOptions.RemoveEmptyEntries);
            for (int i =0; i < splitDesc.Length; ++i)
            {
                paragraphs.Add((MarkupString)GameEngine.CensorHint(title, splitDesc[i] + "</p>"));
            } 
            if (paragraphs.Count > 0)
                hint2 = paragraphs[0];
        }
        catch
        {
            //todo: catch errors

        }
    }

    private void PickAnswer(string answer)
    {
        attempts++;
        if (answer.Equals(title))
            correctGuess = true;

        if (attempts >= 4 && attempts % 2 == 0 && paragraphs.Count > (attempts-2) / 2)
            hint2 = (MarkupString)(hint2.ToString() + paragraphs[(attempts - 2) / 2].ToString());
    }

    private async Task PickCategory(string categ)
    {
        category = categ;
        await InitializeGame();
    }


}